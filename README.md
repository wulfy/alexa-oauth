# alexa-oauth

Alexa oauth custom mangement.

For now this repository is a tutorial for me to learn how OAuth works and how Alexa implement it to link skills with Alexa accounts.

This project is used with another project under development which plan to manage ZWaves devices threw Amazon Home Kit and Domoticz API.

## Run project
`node index.js` to launch the server

## Debug
The server use "debug" module to display debug depending on desired category

This example display all debug traces
`DEBUG=* node index.js`

This one only oauth debug
`DEBUG=oauth node index.js`

Here is the debug list (you can find the configuration in /utils/logger.js):
'prod','debug','database','oauth'


## Code Architecture
### Packages
**Express** to manage rendering and routing
**PUG** for templating
**Nodemailer** to send emails (for lost password for example)
**Mysql** to connect to the database containing users data and tokens

### Files
index.js : file called by node to launch the app
app.js : file containing the app 
oauthapi.js : oauth api implementation (functions called for each oauth step)
views/. : templates
utils/. : utility files, used to manage security, retrieve domoticz URL, send email, etc.

## Workflow
To use the service, users have to register on the website.
Then, the must use their account in Alexa skill connection.
When connected, Alexa will ask for a token (using OAUTH2 protocol).
When the token is outdated, a new one is generated by using the refresh token

### Account creation
/register ask user to create an account (email/pass).
Once the account is created, the user can fill domoticz connection infos (url, credentials, etc.).
When thos data are filled, the server will try to connect to the Domoticz server and tell the user if it's a success or not.
As long as the connection is not valid (domoticz connection information are missing or not valid), Alexa will not work

### Token lifecycle
- When the user connect on the server threw Alexa skill interface using the /login route
- the appserver will identify user and check if it's a request from Alexa or website
`if(redirect_uri && state )`
Alexa is sending state and redirect, when connexion is ok, the server redirect to Alexa with redirect and send thos parameters:
	- state
	- credentials to ask for a token (to identify it's Alexa who asked)
	- a 'code' generated for the user, Alexa must use to ask for a token
- Alexa will use those credentials by calling /oauth/token and will pass the user 'code' 
- The server will 
	- getClient => to check if client exists and credentials are correct
	- getAuthorizationCode => to check the user code and retrieve the userID
	- saveToken => the oauth package will generate a token and a refresh token and save it in this function then return it
	- the server will return the token and oauth headers
- For refresh Alexa will call same URL /oauth/token with a grant_type header setted to refresh_token and a refresh token
	- the server will search for the refresh token, if found, generate a new token and refresh token and update the data for the client and user (savetoken function take a token, a client and a user)
	So the same oauthserver, can manage multiple clients (alexa, google, etc.) and not mixed users from a client to another.
- For data retrieval
	- Alexa will present the token to the skill (the token is used between Alexa and the app that need id. So Alexa never store user's datas). The skill will use token to retrieve user's data and build domoticz request

